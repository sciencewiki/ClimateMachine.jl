<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>How to make a balance law · CLIMA</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="CLIMA logo"/></a><div class="docs-package-name"><span class="docs-autofit">CLIMA</span></div><form class="docs-search" action="../../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><a class="tocitem" href="../../../../Installation/">Installation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Atmos</span></li><li><span class="tocitem">Ocean</span></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-3-1"><span class="docs-label">LinearSolvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../generated/Numerics/LinearSolvers/cg/">Conjugate Gradient</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-3-2"><span class="docs-label">Contributing</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../generated/literate_markdown/">Notes on Literate</a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Extending CLIMA</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Contributing/CONTRIBUTING/">Home</a></li><li><span class="tocitem">Arrays</span></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Common/SurfaceFluxes/">SurfaceFluxes</a></li><li><a class="tocitem" href="../../../Common/MoistThermodynamics/">MoistThermodynamics</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-4" type="checkbox"/><label class="tocitem" for="menuitem-4-4"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../Atmos/Microphysics/">Microphysics</a></li><li><a class="tocitem" href="../../../Atmos/Model/turbulence/">Turbulence</a></li><li><a class="tocitem" href="../../../Atmos/Model/tracers/">Tracers</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-4-7" type="checkbox"/><label class="tocitem" for="menuitem-4-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../Diagnostics/DiagnosticVariables/">Variables</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-8" type="checkbox" checked/><label class="tocitem" for="menuitem-4-8"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><span class="tocitem">Meshes</span></li><li><input class="collapse-toggle" id="menuitem-4-8-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-8-2"><span class="docs-label">DG methods</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>How to make a balance law</a><ul class="internal"><li><a class="tocitem" href="#Variable-name-specification-methods-1"><span>Variable name specification methods</span></a></li><li><a class="tocitem" href="#Methods-to-compute-RHS-source-terms-/-BCs-1"><span>Methods to compute RHS source terms / BCs</span></a></li><li class="toplevel"><a class="tocitem" href="#Reference-links-1"><span>Reference links</span></a></li></ul></li></ul></li><li><span class="tocitem">ODE Solvers</span></li><li><input class="collapse-toggle" id="menuitem-4-8-4" type="checkbox"/><label class="tocitem" for="menuitem-4-8-4"><span class="docs-label">Linear Solvers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../LinearSolvers/IterativeSolvers/">Iterative Solvers</a></li></ul></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/">Home</a></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Atmos/AtmosModel/">AtmosModel</a></li><li><a class="tocitem" href="../../../../APIs/Atmos/Microphysics/">Microphysics</a></li></ul></li><li><span class="tocitem">Ocean</span></li><li><span class="tocitem">Land</span></li><li><input class="collapse-toggle" id="menuitem-5-5" type="checkbox"/><label class="tocitem" for="menuitem-5-5"><span class="docs-label">Common</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Common/SurfaceFluxes/">Surface Fluxes</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/Arrays/Arrays/">Arrays</a></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Diagnostics/Diagnostics/">List of variables</a></li><li><a class="tocitem" href="../../../../APIs/Diagnostics/InputOutput/">Input/Output</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-8" type="checkbox"/><label class="tocitem" for="menuitem-5-8"><span class="docs-label">Numerics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Numerics/Meshes/Mesh/">Meshes</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/LinearSolvers/LinearSolvers/">LinearSolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/ODESolvers/ODESolvers/">ODESolvers</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGmethods/DGmethods_old/">DG methods (old)</a></li><li><a class="tocitem" href="../../../../APIs/Numerics/DGmethods/BalanceLawOverview/">Balance Law</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Theory &amp; design philosophy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Discussions/">Home</a></li><li><input class="collapse-toggle" id="menuitem-6-2" type="checkbox"/><label class="tocitem" for="menuitem-6-2"><span class="docs-label">Atmos</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../Discussions/Atmos/EDMFEquations/">Eddy-Diffusivity Mass-Flux (EDMF) equations</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox"/><label class="tocitem" for="menuitem-7"><span class="docs-label">Developer docs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../CodingConventions/">Coding Conventions</a></li><li><a class="tocitem" href="../../../../AcceptableUnicode/">Acceptable Unicode characters</a></li><li><a class="tocitem" href="../../../../VariableList/">CliMA Variable List</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Extending CLIMA</a></li><li><a class="is-disabled">Numerics</a></li><li><a class="is-disabled">DG methods</a></li><li class="is-active"><a href>How to make a balance law</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>How to make a balance law</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/climate-machine/CLIMA/blob/master/docs/src/ExtendingCLIMA/Numerics/DGmethods/how_to_make_a_balance_law.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="How-to-make-a-Balance-law-1"><a class="docs-heading-anchor" href="#How-to-make-a-Balance-law-1">How to make a Balance law</a><a class="docs-heading-anchor-permalink" href="#How-to-make-a-Balance-law-1" title="Permalink"></a></h1><p>Defining the set of solved PDEs in CLIMA revolve around defining a <a href="ExtendingCLIMA/Numerics/DGmethods/@ref"><code>BalanceLaw</code></a>. A balance law solves equations of the form:</p><pre><code class="language-none">∂Y
-- = - ∇ • (F_{diffusive}(G, Y) + F_{non_diffusive}(Y)) + S_{non_conservative}(G, Y)
∂t</code></pre><p>Here, <code>Y</code>, <code>G</code>, <code>F_{diffusive}</code>, <code>F_{non_diffusive}</code>, and <code>S_{non_conservative}</code> can be thought of column vectors<sup class="footnote-reference"><a id="citeref-1" href="#footnote-1">[1]</a></sup> expressing:</p><ul><li><code>Y</code> the state variables, or unknowns of the PDEs to be solved</li><li><code>G</code> gradients of variables</li><li><code>F_{diffusive}</code> is non-diffusive fluxes (are <strong>not</strong> functions of gradients of any variables)</li><li><code>F_{non_diffusive}</code> is diffusive fluxes (are functions of gradients of any variables)</li><li><code>S_{non_conservative}</code> non-conservative sources<sup class="footnote-reference"><a id="citeref-2" href="#footnote-2">[2]</a></sup></li></ul><p>In order to alleviate users from being concerned with the burden of spatial discretization, users must provide their own implementations of the following methods:</p><h2 id="Variable-name-specification-methods-1"><a class="docs-heading-anchor" href="#Variable-name-specification-methods-1">Variable name specification methods</a><a class="docs-heading-anchor-permalink" href="#Variable-name-specification-methods-1" title="Permalink"></a></h2><table><tr><th style="text-align: left"><strong>Method</strong></th><th style="text-align: left">Purpose</th></tr><tr><td style="text-align: left"><a href="ExtendingCLIMA/Numerics/DGmethods/@ref"><code>vars_state</code></a></td><td style="text-align: left">specify the names of the unknowns</td></tr><tr><td style="text-align: left"><a href="ExtendingCLIMA/Numerics/DGmethods/@ref"><code>vars_aux</code></a></td><td style="text-align: left">specify variable names needed to solve expensive auxiliary equations (e.g., temperature via a non-linear equation solve)</td></tr></table><h2 id="Methods-to-compute-RHS-source-terms-/-BCs-1"><a class="docs-heading-anchor" href="#Methods-to-compute-RHS-source-terms-/-BCs-1">Methods to compute RHS source terms / BCs</a><a class="docs-heading-anchor-permalink" href="#Methods-to-compute-RHS-source-terms-/-BCs-1" title="Permalink"></a></h2><table><tr><th style="text-align: left"><strong>Method</strong></th><th style="text-align: left">Purpose</th></tr><tr><td style="text-align: left"><a href="ExtendingCLIMA/Numerics/DGmethods/@ref"><code>flux_diffusive!</code></a></td><td style="text-align: left">specify <code>F_{diffusive}</code></td></tr><tr><td style="text-align: left"><a href="ExtendingCLIMA/Numerics/DGmethods/@ref"><code>flux_nondiffusive!</code></a></td><td style="text-align: left">specify <code>F_{non_diffusive}</code></td></tr><tr><td style="text-align: left"><a href="ExtendingCLIMA/Numerics/DGmethods/@ref"><code>source!</code></a></td><td style="text-align: left">specify <code>S_{non_conservative}</code></td></tr></table><p>While <code>Y</code> can be thought of a column vector (each <em>row</em> of which corresponding to each equation), the <em>second</em> function argument inside these methods behave as dictionaries, for example:</p><pre><code class="language-none">struct MyModel &lt;: BalanceLaw end

function vars_state(m::MyModel, FT)
    @vars begin
        ρ::FT
        T::FT
    end
end

function source!(m::MyModel, source::Vars, args...)
    source.ρ = 1 # adds a source of 1 to RHS of ρ equation
    source.T = 1 # adds a source of 1 to RHS of T equation
end</code></pre><p>All equations are marched simultaneously in time.</p><h1 id="Reference-links-1"><a class="docs-heading-anchor" href="#Reference-links-1">Reference links</a><a class="docs-heading-anchor-permalink" href="#Reference-links-1" title="Permalink"></a></h1><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-1"><a class="tag is-link" href="#citeref-1">1</a><a href="https://en.wikipedia.org/wiki/Row_and_column_vectors">Column Vectors</a></li><li class="footnote" id="footnote-2"><a class="tag is-link" href="#citeref-2">2</a>Note that using non-conservative sources should be a final resort, as this can leak conservation of the unknowns and lead to numerical instabilities. It is recommended to use either <code>F_{diffusive}</code> or <code>F_{non_diffusive}</code>, as these fluxes are communicated across elements<sup class="footnote-reference"><a id="citeref-3" href="#footnote-3">[3]</a></sup></li><li class="footnote" id="footnote-3"><a class="tag is-link" href="#citeref-3">3</a>MPI communication occurs only across elements, not within each element, where there may be many [Gauss-Lobatto]<sup class="footnote-reference"><a id="citeref-4" href="#footnote-4">[4]</a></sup> points</li><li class="footnote" id="footnote-4"><a class="tag is-link" href="#citeref-4">4</a><a href="https://en.wikipedia.org/wiki/Gaussian_quadrature#Gauss%E2%80%93Lobatto_rules">Gauss-Lobatto</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../../Diagnostics/DiagnosticVariables/">« Variables</a><a class="docs-footer-nextpage" href="../../LinearSolvers/IterativeSolvers/">Iterative Solvers »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Monday 27 April 2020 17:50">Monday 27 April 2020</span>. Using Julia version 1.3.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
